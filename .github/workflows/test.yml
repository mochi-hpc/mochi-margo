name: test

on: [push,pull_request,workflow_dispatch]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Configure
      uses: ./.github
      with:
        builddir: build
    - name: Run test
      id: test
      run: |
        eval `/opt/spack/bin/spack env activate --sh .` &&
        cd build &&
        make check
    - name: Show test-suite.log if test failed
      if: failure() && steps.test.outcome == 'failure'
      run: |
        cat build/test-suite.log
  asan:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Configure
      uses: ./.github
      with:
        builddir: asan-build
        CFLAGS: '-fsanitize=address -fno-omit-frame-pointer -g -Wall'
        LDFLAGS: '-fsanitize=address'
    - name: Run test
      id: asan-test
      run: |
        eval `/opt/spack/bin/spack env activate --sh .` &&
        cd asan-build &&
        export ASAN_OPTIONS="abort_on_error=1" &&
        make check
    - name: Show test-suite.log if test failed
      if: failure() && steps.asan-test.outcome == 'failure'
      run: |
        cat asan-build/test-suite.log
